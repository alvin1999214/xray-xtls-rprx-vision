# Use Docker Compose setup VLESS+Reality

## Step of Setup
### 1. Create Docker Compose and Xray config file

Create dir for xray-reality

```
mkdir xray-reality
cd xray-reality
```

create 2 core file：`docker-compose.yml` 和 `config.json`

`docker-compose.yml` content：
```
version: '3'
services:
  xray:
    image: teddysun/xray
    container_name: xray-reality
    restart: always
    network_mode: host
    volumes:
      - ./config.json:/etc/xray/config.json
      - /etc/localtime:/etc/localtime:ro
    environment:
      - TZ=Asia/Shanghai
```
### 2. Generate Key and Value for Reality
Key config for setup Reality：

UUID

Private Key & Public Key

Short ID

Generated by Xray, Run the Docker command below：

Generate key pair:
```
docker run --rm teddysun/xray xray x25519
```

Generate UUID：
```
docker run --rm teddysun/xray xray uuid
```

Generate shortIDs：
```
openssl rand -hex 8
```

### 3. Setup `config.json` 
Fill all key and value in `config.json` 

`config.json` content：
```
{
  "log": {
    "loglevel": "warning"
  },
  "inbounds": [
    {
      "listen": "0.0.0.0",
      "port": 443,
      "protocol": "vless",
      "settings": {
        "clients": [
          {
            "id": "Your UUID Value",
            "flow": "xtls-rprx-vision"
          }
        ],
        "decryption": "none"
      },
      "streamSettings": {
        "network": "tcp",
        "security": "reality",
        "realitySettings": {
          "show": false,
          "dest": "www.apple.com:443",
          "xver": 0,
          "serverNames": [
            "www.apple.com",
            "www.icloud.com"
          ],
          "privateKey": "Your Private Key value",
          "shortIds": [
            "Your Short ID Value"
          ]
        }
      }
    }
  ],
  "outbounds": [
    {
      "protocol": "freedom",
      "tag": "direct"
    },
    {
      "protocol": "blackhole",
      "tag": "block"
    }
  ]
}
```
### 4. Start services
Save two file and run the command below in xray-reality dir
```
docker-compose up -d
```

### 5. Copy the patten below and paste in Shadowrocket. Please replace {} to your own ID and IP
```
vless://{你的uuid}@{主機ip}:443?security=reality&sni=www.apple.com&flow=xtls-rprx-vision&publicKey={公鑰}&sid={短ID}#VLESS-Reality-Apple

```

### 6. Setup iptable (e.g. Oracle VM)
Check iptables
```
sudo iptables -L INPUT -n --line-numbers
```
If output is:
```
Chain INPUT (policy ACCEPT)
num  target     prot opt source               destination
```
No need to setup iptables

If output is:
```
Chain INPUT (policy ACCEPT)
num  target     prot opt source               destination         
1    ACCEPT     all  --  0.0.0.0/0            0.0.0.0/0            state RELATED,ESTABLISHED
2    ACCEPT     icmp --  0.0.0.0/0            0.0.0.0/0           
3    ACCEPT     all  --  0.0.0.0/0            0.0.0.0/0           
4    ACCEPT     tcp  --  0.0.0.0/0            0.0.0.0/0            state NEW tcp dpt:22
5    REJECT     all  --  0.0.0.0/0            0.0.0.0/0            reject-with icmp-host-prohibited
```
The `5    REJECT     all  --  0.0.0.0/0            0.0.0.0/0            reject-with icmp-host-prohibited` will reject 443 in

Please enter the below command to allow 443 port
```
sudo iptables -I INPUT 5 -p tcp --dport 443 -j ACCEPT
sudo netfilter-persistent save
```
